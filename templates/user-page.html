{% include "header.html" %}
<div class="card mb-4">
  <button id="edit-customerdetails-button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#edit-customerdetails-modal">Edit details</button>
    <div class="card-body text-center">
        <div class="row">
            <div class="col-sm-3">
                <p class="mb-0">Full Name</p>
            </div>
            <div class="col-sm-9">
                <p class="text-muted mb-0">{{user.customerDetails.first_name.title()}} {{user.customerDetails.last_name.title()}}</p>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-sm-3">
                <p class="mb-0">Email</p>
            </div>
            <div class="col-sm-9">
                <p class="text-muted mb-0">{{user.email}}</p>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-sm-3">
                <p class="mb-0">Date of Birth</p>
            </div>
            <div class="col-sm-9">
                <p class="text-muted mb-0">{{user.customerDetails.date_of_birth}}</p>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-sm-3">
                <p class="mb-0">Phone Number</p>
            </div>
            <div class="col-sm-9">
                <p class="text-muted mb-0">{{user.customerDetails.phone_number}}</p>
            </div>
        </div>
        <hr>
    </div>
    <!-- Edit details modal -->
    <div class="modal fade" id="edit-customerdetails-modal" tabindex="-1" aria-labelledby="edit-customerdetails-modal-label" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="edit-customerdetails-modal-label">Edit details </h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="edit-customerdetails" action="{{url_for('edit_user_details')}}" method="post">
            <div class="modal-body">
              {{detailform.csrf_token}}
            <div class="mb-3">
                {{detailform.first_name.label}}
                {{detailform.first_name(class="form-control")}}
              </div>
            <div class="mb-3">
                {{detailform.last_name.label}}
                {{detailform.last_name(class="form-control")}}
              </div>
            <div class="mb-3">
                {{detailform.date_of_birth.label}}
                {{detailform.date_of_birth(class="form-control")}}
              </div>
            <div class="mb-3">
                {{detailform.phone_code.label}}
                {{detailform.phone_code(class="form-control")}}
              </div>
            <div class="mb-3">
                {{detailform.phone_number.label}}
                {{detailform.phone_number(class="form-control")}}
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              {{detailform.submit(id="edit-customerdetails-submit", class="btn btn-primary")}}
            </div>
          </form>
        </div>
      </div>
    </div>
</div>
<div class="d-flex flex-column flex-md-row p-4 gap-4 py-md-5 align-items-center justify-content-center">
    <main class="w-100 m-auto">
    <button id="add-user-address" class="btn btn-primary w-100 my-3 py-2" data-bs-toggle="modal" data-bs-target="#add-address-modal">Add new address</button>
    {% if user.customerDetails.addresses|length != 0 %}
    <div class="accordion" id="address-accordion">
      {% for address in user.customerDetails.addresses %}
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#address-collapse-{{address.id}}" aria-expanded="false" aria-controls="#address-collapse-{{address.id}}">
              <address id="address-{{address.id}}">
                {{address.address_one}}<br>
                {{address.address_two}}<br>
                {{address.city}}<br>
                {{address.country}}<br>
              </address>
            </button>
          </h2>
          <div id="address-collapse-{{address.id}}" class="accordion-collapse collapse" data-bs-parent="#address-accordion">
            <div class="accordion-body">
              <p>{{address.phone_number}}</p>
              <button id="edit-user-address-{{address.id}}" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#edit-address-modal-{{address.id}}">Edit address</button>
              <a href="{{url_for('delete_address', address_id=address.id)}}" id="delete-address-{{address.id}}" class="btn btn-danger w-100">Delete address</a>
            </div>
          </div>
        </div>
        <!-- Edit modal -->
        <div class="modal fade" id="edit-address-modal-{{address.id}}" tabindex="-1" aria-labelledby="edit-address-modal-label-{{address.id}}" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="edit-address-modal-label-{{address.id}}">Add address</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <form id="edit-address-{{address.id}}" action="{{url_for('edit_address', address_id=address.id)}}" method="post">
                <div class="modal-body">
                  {{form.csrf_token}}
                  <div class="mb-3">
                      {{form.address_one.label(for="edit-address_one-"+address.id|string)}}
                      {{form.address_one(id="edit-address_one-"+address.id|string, class="form-control")}}
                  </div>
                  <div class="mb-3">
                      {{form.address_two.label(for="edit-address_two-"+address.id|string)}}
                      {{form.address_two(id="edit-address_two-"+address.id|string, class="form-control")}}
                  </div>
                  <div class="mb-3">
                      {{form.country.label(for="edit-address_country"+address.id|string)}}
                      {{form.country(id="edit-country-"+address.id|string, class="form-control")}}
                  </div>
                  <div class="mb-3">
                      {{form.state.label(for="edit-state-"+address.id|string)}}
                      {{form.state(id="edit-state-"+address.id|string, class="form-control")}}
                  </div>
                  <div class="mb-3">
                      {{form.city.label(for="edit-city-"+address.id|string)}}
                      {{form.city(id="edit-city-"+address.id|string, class="form-control")}}
                  </div>
                  <div class="mb-3">
                      {{form.postal_code.label(for="edit-postal_code-"+address.id|string)}}
                      {{form.postal_code(id="edit-postal_code-"+address.id|string, class="form-control")}}
                  </div>
                  <div class="mb-3">
                      {{form.same_number(id="edit-same_number-"+address.id|string)}}
                      {{form.same_number.label(for="edit-same_number-"+address.id|string)}}
                  </div>
                  <div class="mb-3">
                      {{form.phone_code.label(for="edit-phone_code-"+address.id|string)}}
                      {{form.phone_code(id="edit-phone_code-"+address.id|string, class="form-control")}}
                  </div>
                  <div class="mb-3">
                      {{form.phone_number.label(for="edit-phone_number-"+address.id|string)}}
                      {{form.phone_number(id="edit-phone_number-"+address.id|string, class="form-control")}}
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  {{ form.submit(id="edit-address-submit-{{address.id}}", class="btn btn-primary") }}
                </div>
              </form>
            </div>
          </div>
        </div>
        <script type="text/javascript">
          $("#edit-user-address-{{address.id}}").click(function(event){
            event.preventDefault();

            $.get(
              "{{url_for('edit_address', address_id=address.id)}}",
              {},
              function(data){
                $("#edit-address-modal-label-{{address.id}}").text("Edit address")
                $("#edit-address_one-{{address.id}}").val(data.address.address_one)
                $("#edit-address_two-{{address.id}}").val(data.address.address_two)
                $("#edit-state-{{address.id}}").val(data.address.state)
                $("#edit-city-{{address.id}}").val(data.address.city)
                $("#edit-postal_code-{{address.id}}").val(data.address.postal_code)
                $("#edit-country-{{address.id}}").val(data.address.country)
                $("#edit-phone_code-{{address.id}}").val(data.address.phone_code)
                $("#edit-phone_number-{{address.id}}").val(data.address.phone_number)
              }
            )
          })
          
          $("#edit-address-{{address.id}}").submit(function(event){
            event.preventDefault();

            if($("#edit-phone_number-{{address.id}}").attr("disabled")){
              $("#edit-phone_number-{{address.id}}").removeAttr("disabled")
              $("#edit-phone_code-{{address.id}}").removeAttr("disabled")
            }

            $.post(
              $(this).attr("action"),
              $(this).serialize(),
              function(data){
                location.reload()
                alert("Address has been updated")
              }
            )
          })

          $("#delete-address-{{address.id}}").click(function(event){
            event.preventDefault();
            let delConfirm = confirm("Do you want to delete this address?")
            if(delConfirm==true){
              $.get(
                $(this).attr("href"),
                {},
                function(data){
                  location.reload();
                  alert("Address has been deleted")
                }
              )
            }
          })

          $("#edit-same_number-{{address.id}}").change((event)=>{
            event.preventDefault();
            // https://stackoverflow.com/questions/43446641/jquery-attribute-exists-or-not
            if(!($("#edit-phone_number-{{address.id}}").attr("disabled"))){
              $("#edit-phone_number-{{address.id}}").attr("disabled", true)
              $("#edit-phone_code-{{address.id}}").attr("disabled", true)
            }else{
              $("#edit-phone_number-{{address.id}}").removeAttr("disabled")
              $("#edit-phone_code-{{address.id}}").removeAttr("disabled")
            }
          })
        </script>
        {% endfor %}
    </div>
    {% else %}
    <h1 class="h3 text-center">You have not saved any addresses</h1>
    <h1 class="h3 text-center">Please add one us
    {% endif %}
    </main>
    <div class="modal fade" id="add-address-modal" tabindex="-1" aria-labelledby="add-address-modal-label" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="add-address-modal-label">Add address</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="add-address" action="{{url_for('add_address')}}" method="post">
              {{form.csrf_token}}
              <div class="modal-body">
                <div class="mb-3">
                    {{form.address_one.label}}
                    {{form.address_one(class="form-control")}}
                </div>
                <div class="mb-3">
                    {{form.address_two.label}}
                    {{form.address_two(class="form-control")}}
                </div>
                <div class="mb-3">
                    {{form.country.label}}
                    {{form.country(class="form-control")}}
                </div>
                <div class="mb-3">
                    {{form.state.label}}
                    {{form.state(class="form-control")}}
                </div>
                <div class="mb-3">
                    {{form.city.label}}
                    {{form.city(class="form-control")}}
                </div>
                <div class="mb-3">
                    {{form.postal_code.label}}
                    {{form.postal_code(class="form-control")}}
                </div>
                <div class="mb-3">
                    {{form.same_number}}
                    {{form.same_number.label}}
                </div>
                <div class="mb-3">
                    {{form.phone_code.label}}
                    {{form.phone_code(class="form-control")}}
                </div>
                <div class="mb-3">
                    {{form.phone_number.label}}
                    {{form.phone_number(class="form-control")}}
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                {{ form.submit(class="btn btn-primary") }}
              </div>
            </form>
          </div>
        </div>
      </div>
</div>
<!-- TODO scripts for post/ajax -->
<script type="text/javascript">
    $("#add-address").submit(function(event){
      event.preventDefault();
      // https://stackoverflow.com/questions/6162573/jquery-form-serialize-returns-an-empty-string
      // Can't be disabled to submit properly
      if($("#phone_number").attr("disabled")){
        $("#phone_number").removeAttr("disabled")
        $("#phone_code").removeAttr("disabled")
      }
      $.post(
        "{{url_for('add_address')}}",
        $(this).serialize(),
        function(data, status){
          if(status){
            alert("Address has been added")
            location.reload()
          }
        }
      )
    })

    $("#same_number").change((event)=>{
      event.preventDefault();
      // https://stackoverflow.com/questions/43446641/jquery-attribute-exists-or-not
      if(!($("#phone_number").attr("disabled"))){
        $("#phone_number").attr("disabled", true)
        $("#phone_code").attr("disabled", true)
      }else{
        $("#phone_number").removeAttr("disabled")
        $("#phone_code").removeAttr("disabled")
      }
    })

    $("#edit-customerdetails-button").click((event)=>{
      event.preventDefault()
      
      $.get(
        "{{url_for('edit_user_details')}}",
        {},
        (data)=>{
          $("#first_name").val(data.customerDetails.first_name)
          $("#last_name").val(data.customerDetails.last_name)
          $("#date_of_birth").val(data.customerDetails.dob)
          $("#phone_code").val(data.customerDetails.phone_code)
          $("#phone_number").val(data.customerDetails.phone_number)
        }
      )
    })

    $("#edit-customerdetails").submit(function(event){
      event.preventDefault();

      $.post(
        "{{url_for('edit_user_details')}}",
        $(this).serialize(),
        function(data){
          location.reload()
        }
      )
    })
</script>
{% include "footer.html" %}